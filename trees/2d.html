<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style type="text/css">
        .wrapper {
            border: 1px solid lightblue;
            border-width: 1px 1px 0 1px;
            padding: 0.25rem 0.5rem;
        }
    </style>
</head>
<body>

<canvas id="canvas" width="400" height="400"></canvas>
<div id="controls"></div>
<script type="module">
    function xmur3(str) {
        for(var i = 0, h = 1779033703 ^ str.length; i < str.length; i++)
            h = Math.imul(h ^ str.charCodeAt(i), 3432918353),
                h = h << 13 | h >>> 19;
        return function() {
            h = Math.imul(h ^ h >>> 16, 2246822507);
            h = Math.imul(h ^ h >>> 13, 3266489909);
            return (h ^= h >>> 16) >>> 0;
        }
    }

    function sfc32(a, b, c, d) {
        return function() {
            a >>>= 0; b >>>= 0; c >>>= 0; d >>>= 0;
            var t = (a + b) | 0;
            a = b ^ b >>> 9;
            b = c + (c << 3) | 0;
            c = (c << 21 | c >>> 11);
            d = d + 1 | 0;
            t = t + d | 0;
            c = c + t | 0;
            return (t >>> 0) / 4294967296;
        }
    }

    // const seed = xmur3('apple')
    // const random =sfc32(seed(),seed(),seed(),seed())
    const toRad = (deg) => deg/180*Math.PI

    let opts = {
        trunkWidth:30,
        trunkHeight:80,
        leafSize:20,
        seed:'apple',
        leafType:'circle',
        maxDepth:4,
        // random: random
    }

    const canvas = document.getElementById('canvas')
    const ctx = canvas.getContext('2d')
    let w = 400
    let h = 400

    const randf = (random, min,max) => min + random()*(max-min)

    function leaf(ctx, w,h, opts) {
        ctx.fillStyle = 'blue'
        let s = opts.leafSize
        if(opts.leafType === 'square') {
            ctx.fillRect(-s, -s, s * 2, s * 2)
        }
        if(opts.leafType === 'circle') {
            ctx.beginPath()
            ctx.arc(0,0,s,0,toRad(360))
            ctx.fill()
        }
    }

    function branch(ctx, w, h,depth, opts) {
        ctx.save()
        const nw = w*randf(opts.random,0.5,0.9)
        const nh = h*randf(opts.random,0.5,0.9)
        ctx.translate(-nw/2,nh+2)
        ctx.rotate(randf(opts.random,0.2,0.8))
        trunk(ctx,nw,nh,depth-1, opts)
        ctx.restore()
        ctx.save()
        ctx.translate(+nw/2,nh+2)
        ctx.rotate(randf(opts.random,-0.2,-0.8))
        trunk(ctx,nw,nh,depth-1, opts)
        ctx.restore()
    }

    function trunk(ctx, w, h, depth, opts) {
        // console.log(depth,opts)
        if(depth === 0) return leaf(ctx,w, h,opts)
        ctx.fillStyle = 'brown'
        ctx.fillRect(-w/4,-h/2,w/2,h)
        if(depth > 0) {
            branch(ctx,w,h,depth, opts)
        }
    }


    function makeSlider(opts,name, updateFun, config) {
        if(!config) config = {}
        let initialValue = opts[name]
        let wrapper = document.createElement('div')
        wrapper.classList.add('wrapper')

        let label = document.createElement('label')
        label.innerText = name
        wrapper.appendChild(label)

        let valueLabel = document.createElement('label')

        let elem = document.createElement('input')
        elem.setAttribute('type','range')
        elem.setAttribute('value',initialValue)
        elem.setAttribute('step',0.1)
        if('step' in config) elem.setAttribute('step',config.step)
        if('min' in config) elem.setAttribute('min',config.min)
        if('max' in config) elem.setAttribute('max',config.max)

        valueLabel.innerText = elem.getAttribute('value')
        wrapper.appendChild(elem)
        elem.addEventListener('input',()=>{
            valueLabel.innerText = elem.value
            const val = parseFloat(elem.value)
            opts[name] = val
            updateFun(opts)
        })

        wrapper.appendChild(valueLabel)
        document.getElementById('controls').appendChild(wrapper)
    }

    function makeButton(opts,name,updateFun,config) {
        let wrapper = document.createElement('div')
        wrapper.classList.add('wrapper')
        let button = document.createElement('button')
        button.innerText = name
        button.addEventListener('click',config.action)
        wrapper.appendChild(button)
        document.getElementById('controls').appendChild(wrapper)

    }


    function gen(opts) {
        const seed = xmur3(opts.seed)
        opts.random =sfc32(seed(),seed(),seed(),seed())
        ctx.fillStyle = '#f0f0f0'
        ctx.fillRect(0,0,w,h)

        let width = opts.trunkWidth
        let height = opts.trunkHeight
        ctx.save()
        ctx.translate(w/2,h/2+h/3)
        ctx.scale(1,-1)
        trunk(ctx, width, height, opts.maxDepth, opts)
        ctx.restore()
    }

    makeButton(opts,'randomize',gen,{action:()=>{
            opts.seed = ""+Math.random()
            gen(opts)
        }})
    makeSlider(opts,'trunkWidth',gen)
    makeSlider(opts,'trunkHeight',gen)
    makeSlider(opts,'leafSize',gen, {min:0, max:30})
    makeSlider(opts,'maxDepth',gen, {min:1, max:8, step:1})

    gen(opts)


</script>

</body>
</html>
